<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CyberArchitect: IEC 62443 CAD Twin</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Import Map for React + Three.js + Fiber -->
    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.2.0",
                "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
                "three": "https://esm.sh/three@0.160.0",
                "@react-three/fiber": "https://esm.sh/@react-three/fiber@8.15.14?external=react,react-dom,three",
                "@react-three/drei": "https://esm.sh/@react-three/drei@9.99.0?external=react,react-dom,three,@react-three/fiber",
                "lucide-react": "https://esm.sh/lucide-react@0.300.0?external=react"
            }
        }
    </script>

    <!-- Babel for in-browser JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background-color: #0f172a; color: white; }
        .canvas-container { width: 100vw; height: 100vh; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo, Suspense } from 'react';
        import { createRoot } from 'react-dom/client';
        import * as THREE from 'three';
        import { Canvas, useFrame, useThree } from '@react-three/fiber';
        import { 
            OrbitControls, Text, Grid as Grid3D, PerspectiveCamera, 
            Environment, ContactShadows, Float, RoundedBox 
        } from '@react-three/drei';
        import { 
            Shield, Box, Activity, Server, Cpu, Wifi, Database, 
            Layers, Play, Save, ZoomIn, ZoomOut, CheckCircle, 
            AlertTriangle, Rotate3D, LayoutDashboard, MousePointer2 
        } from 'lucide-react';

        // --- CONSTANTS & CONFIG ---

        const GRID_SIZE = 20;
        
        const ASSET_TYPES = {
            PLC: { label: 'PLC Controller', color: '#3b82f6', sl: 2, height: 1.5, shape: 'box' },
            HMI: { label: 'HMI Panel', color: '#10b981', sl: 1, height: 1.2, shape: 'screen' },
            SERVER: { label: 'Historian', color: '#8b5cf6', sl: 3, height: 2.5, shape: 'tower' },
            IOT: { label: 'IoT Sensor', color: '#ef4444', sl: 0, height: 0.8, shape: 'sphere' },
            ENG: { label: 'Workstation', color: '#f59e0b', sl: 2, height: 1.2, shape: 'screen' }
        };

        const INITIAL_NODES = [
            { id: 'n1', type: 'PLC', x: 200, y: 200, sl: 2, zoneId: 'z1' },
            { id: 'n2', type: 'HMI', x: 400, y: 200, sl: 1, zoneId: 'z1' },
            { id: 'n3', type: 'SERVER', x: 600, y: 300, sl: 3, zoneId: 'z2' }
        ];

        const INITIAL_ZONES = [
            { id: 'z1', name: 'Control Zone', x: 150, y: 150, width: 350, height: 200, slTarget: 2 },
            { id: 'z2', name: 'DMZ', x: 550, y: 250, width: 200, height: 200, slTarget: 3 }
        ];

        const INITIAL_EDGES = [
            { id: 'e1', source: 'n1', target: 'n2', handleS: 'r', handleT: 'l' },
            { id: 'e2', source: 'n1', target: 'n3', handleS: 'r', handleT: 'l' }
        ];

        // --- 3D COMPONENTS (The CAD Engine) ---

        const Asset3D = ({ node, isSelected }) => {
            const config = ASSET_TYPES[node.type];
            // Map 2D coords (Top-Left origin) to 3D world (Center origin, Y-up)
            // Scaling factor: 0.02 to convert pixels to meters
            const x = node.x * 0.02; 
            const z = node.y * 0.02; 
            
            return (
                <group position={[x, config.height/2 + 0.2, z]}>
                    <Float speed={2} rotationIntensity={0.2} floatIntensity={0.2}>
                        <mesh onClick={(e) => { e.stopPropagation(); /* select logic */ }}>
                            {config.shape === 'sphere' ? (
                                <sphereGeometry args={[0.4, 32, 32]} />
                            ) : (
                                <boxGeometry args={[1, config.height, 1]} />
                            )}
                            <meshStandardMaterial 
                                color={config.color} 
                                roughness={0.3} 
                                metalness={0.8} 
                                emissive={isSelected ? config.color : '#000'}
                                emissiveIntensity={isSelected ? 0.5 : 0}
                            />
                        </mesh>
                    </Float>
                    {/* Label */}
                    <Text 
                        position={[0, config.height/2 + 0.5, 0]} 
                        fontSize={0.3} 
                        color="white" 
                        anchorX="center" 
                        anchorY="middle"
                        outlineWidth={0.02}
                        outlineColor="#000"
                    >
                        {node.type}
                    </Text>
                    {/* SL Badge */}
                    <Text 
                        position={[0, config.height/2 + 0.9, 0]} 
                        fontSize={0.2} 
                        color={node.sl === 0 ? '#ff5555' : '#aaa'} 
                    >
                        SL-{node.sl}
                    </Text>
                </group>
            );
        };

        const Zone3D = ({ zone }) => {
            // Center the zone mesh based on top-left coords
            const w = zone.width * 0.02;
            const h = zone.height * 0.02;
            const x = (zone.x * 0.02) + (w/2) - 0.5; // Offset correction
            const z = (zone.y * 0.02) + (h/2) - 0.5;

            return (
                <group position={[x, 0, z]}>
                    <RoundedBox args={[w, 0.2, h]} radius={0.1} smoothness={4}>
                        <meshStandardMaterial 
                            color="#1e293b" 
                            transparent 
                            opacity={0.8} 
                            roughness={0.1}
                        />
                    </RoundedBox>
                    {/* Zone Border Glow */}
                    <mesh position={[0, -0.05, 0]}>
                        <boxGeometry args={[w + 0.2, 0.1, h + 0.2]} />
                        <meshBasicMaterial color={zone.slTarget > 2 ? '#ef4444' : '#3b82f6'} />
                    </mesh>
                    <Text 
                        position={[-w/2 + 0.5, 0.2, -h/2 + 0.5]} 
                        rotation={[-Math.PI/2, 0, 0]} 
                        fontSize={0.4}
                        color="#64748b"
                    >
                        {zone.name}
                    </Text>
                </group>
            );
        };

        const Connection3D = ({ edge, nodes }) => {
            const s = nodes.find(n => n.id === edge.source);
            const t = nodes.find(n => n.id === edge.target);
            if (!s || !t) return null;

            const start = new THREE.Vector3(s.x * 0.02, 1, s.y * 0.02);
            const end = new THREE.Vector3(t.x * 0.02, 1, t.y * 0.02);
            
            // Create curve
            const curve = new THREE.CatmullRomCurve3([
                start,
                new THREE.Vector3((start.x + end.x)/2, 2, (start.z + end.z)/2), // Arc up
                end
            ]);

            return (
                <mesh>
                    <tubeGeometry args={[curve, 20, 0.05, 8, false]} />
                    <meshStandardMaterial color="#475569" emissive="#475569" emissiveIntensity={0.2} />
                </mesh>
            );
        };

        const Scene3D = ({ nodes, zones, edges }) => {
            return (
                <>
                    <PerspectiveCamera makeDefault position={[10, 15, 20]} fov={50} />
                    <OrbitControls makeDefault minPolarAngle={0} maxPolarAngle={Math.PI / 2.2} />
                    
                    {/* Lighting */}
                    <ambientLight intensity={0.5} />
                    <spotLight position={[10, 10, 10]} angle={0.15} penumbra={1} intensity={1} castShadow />
                    <pointLight position={[-10, -10, -10]} intensity={1} />
                    <Environment preset="city" />

                    {/* Objects */}
                    <group position={[-10, 0, -10]}> {/* Center world roughly */}
                        {zones.map(z => <Zone3D key={z.id} zone={z} />)}
                        {nodes.map(n => <Asset3D key={n.id} node={n} />)}
                        {edges.map(e => <Connection3D key={e.id} edge={e} nodes={nodes} />)}
                    </group>

                    {/* Floor / Grid */}
                    <Grid3D 
                        position={[0, -0.1, 0]} 
                        args={[100, 100]} 
                        cellSize={1} 
                        cellThickness={0.5} 
                        cellColor="#1e293b" 
                        sectionSize={5} 
                        sectionThickness={1}
                        sectionColor="#334155"
                        fadeDistance={50}
                    />
                    <ContactShadows position={[0, -0.2, 0]} opacity={0.5} scale={50} blur={2} far={4} />
                </>
            );
        };

        // --- 2D CANVAS COMPONENTS ---

        const getHandlePos = (node, h) => {
            const w=140, hT=80; 
            if(h==='t') return {x: node.x+w/2, y: node.y};
            if(h==='r') return {x: node.x+w, y: node.y+hT/2};
            if(h==='b') return {x: node.x+w/2, y: node.y+hT};
            return {x: node.x, y: node.y+hT/2};
        };

        const getPath = (s, t) => {
            const mid = (s.x + t.x)/2;
            return `M ${s.x} ${s.y} L ${mid} ${s.y} L ${mid} ${t.y} L ${t.x} ${t.y}`;
        };

        // --- MAIN APP COMPONENT ---

        const App = () => {
            const [viewMode, setViewMode] = useState('2D'); // '2D' or '3D'
            
            // Data State
            const [nodes, setNodes] = useState(INITIAL_NODES);
            const [zones, setZones] = useState(INITIAL_ZONES);
            const [edges, setEdges] = useState(INITIAL_EDGES);
            
            // 2D Interaction State
            const [viewport, setViewport] = useState({x:0, y:0, zoom:1});
            const [drag, setDrag] = useState(null); // {type, id, startX...}
            const [activePort, setActivePort] = useState(null);

            // Risk State
            const [risks, setRisks] = useState([]);
            const [showReport, setShowReport] = useState(false);

            // -- Logic --

            const handleWheel = (e) => {
                if(viewMode === '3D') return; // Let OrbitControls handle 3D
                if(e.ctrlKey) {
                    e.preventDefault();
                    setViewport(v => ({...v, zoom: Math.min(3, Math.max(0.2, v.zoom - e.deltaY*0.001))}));
                } else {
                    setViewport(v => ({...v, x: v.x - e.deltaX, y: v.y - e.deltaY}));
                }
            };

            const startDrag = (e, type, id) => {
                if(viewMode === '3D') return;
                e.stopPropagation();
                const obj = type==='node' ? nodes.find(n=>n.id===id) : zones.find(z=>z.id===id);
                setDrag({type, id, startX:e.clientX, startY:e.clientY, origX:obj.x, origY:obj.y});
            };

            const onMove = (e) => {
                if(!drag) return;
                const dx = (e.clientX - drag.startX) / viewport.zoom;
                const dy = (e.clientY - drag.startY) / viewport.zoom;
                const nx = Math.round((drag.origX + dx)/20)*20; // Snap
                const ny = Math.round((drag.origY + dy)/20)*20;

                if(drag.type === 'node') {
                    setNodes(ns => ns.map(n => n.id === drag.id ? {...n, x:nx, y:ny} : n));
                } else if(drag.type === 'zone') {
                    // Move zone and its children
                    const zone = zones.find(z=>z.id===drag.id);
                    const diffX = nx - zone.x;
                    const diffY = ny - zone.y;
                    setZones(zs => zs.map(z => z.id === drag.id ? {...z, x:nx, y:ny} : z));
                    setNodes(ns => ns.map(n => n.zoneId === drag.id ? {...n, x:n.x+diffX, y:n.y+diffY} : n));
                }
            };

            const analyze = () => {
                const detected = [];
                edges.forEach(e => {
                    const s = nodes.find(n => n.id === e.source);
                    const t = nodes.find(n => n.id === e.target);
                    if(!s || !t) return;
                    // Example Rule: IoT connected to Control
                    if(s.type === 'IOT' && t.sl >= 2) detected.push("Critical: IoT direct connection to Critical Asset");
                    // Example Rule: Zone Crossing
                    const sz = zones.find(z => z.id === s.zoneId);
                    const tz = zones.find(z => z.id === t.zoneId);
                    if(sz && tz && sz.id !== tz.id && Math.abs(sz.slTarget - tz.slTarget) > 1) {
                        detected.push(`Warning: High SL Gap (${Math.abs(sz.slTarget - tz.slTarget)}) between zones`);
                    }
                });
                setRisks(detected);
                setShowReport(true);
            };

            return (
                <div className="w-full h-full flex flex-col font-sans select-none" onMouseMove={onMove} onMouseUp={() => setDrag(null)}>
                    
                    {/* TOP BAR */}
                    <div className="h-16 bg-slate-900 border-b border-slate-700 flex items-center justify-between px-6 z-20 shadow-xl">
                        <div className="flex items-center gap-4">
                            <div className="bg-blue-600 p-2 rounded-lg shadow-lg shadow-blue-900/50">
                                <Shield className="text-white" size={24} />
                            </div>
                            <div>
                                <h1 className="text-lg font-bold text-white tracking-tight">CyberArchitect <span className="text-blue-400">Pro</span></h1>
                                <p className="text-xs text-slate-400">IEC 62443 Design & Threat Modeling</p>
                            </div>
                        </div>

                        {/* MODE TOGGLE SWITCH */}
                        <div className="flex bg-slate-800 p-1 rounded-lg border border-slate-700">
                            <button 
                                onClick={() => setViewMode('2D')}
                                className={`flex items-center gap-2 px-4 py-2 rounded-md transition-all ${viewMode==='2D' ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}
                            >
                                <LayoutDashboard size={16}/> Schematic (2D)
                            </button>
                            <button 
                                onClick={() => setViewMode('3D')}
                                className={`flex items-center gap-2 px-4 py-2 rounded-md transition-all ${viewMode==='3D' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}
                            >
                                <Rotate3D size={16}/> CAD Twin (3D)
                            </button>
                        </div>

                        <div className="flex items-center gap-3">
                            <button onClick={analyze} className="flex items-center gap-2 px-5 py-2 bg-gradient-to-r from-red-600 to-red-500 hover:from-red-500 hover:to-red-400 text-white font-bold rounded shadow-lg shadow-red-900/20 transition-transform active:scale-95">
                                <Activity size={18}/> Analyze Risk
                            </button>
                        </div>
                    </div>

                    {/* MAIN CONTENT AREA */}
                    <div className="flex-1 relative bg-slate-950 overflow-hidden">
                        
                        {/* --- 2D VIEW --- */}
                        <div 
                            className={`absolute inset-0 transition-opacity duration-500 ${viewMode==='2D' ? 'opacity-100 z-10 pointer-events-auto' : 'opacity-0 z-0 pointer-events-none'}`}
                            onWheel={handleWheel}
                            onMouseDown={(e) => {
                                if(e.target===e.currentTarget) setDrag({type:'viewport', startX:e.clientX, startY:e.clientY, origX:viewport.x, origY:viewport.y})
                            }}
                        >
                            {/* Grid BG */}
                            <div className="absolute inset-0 opacity-20" style={{
                                backgroundImage: 'linear-gradient(#334155 1px, transparent 1px), linear-gradient(90deg, #334155 1px, transparent 1px)',
                                backgroundSize: '20px 20px',
                                transform: `translate(${viewport.x}px, ${viewport.y}px) scale(${viewport.zoom})`,
                                transformOrigin: '0 0'
                            }}/>

                            <div style={{ transform: `translate(${viewport.x}px, ${viewport.y}px) scale(${viewport.zoom})`, transformOrigin:'0 0' }}>
                                {/* Zones */}
                                {zones.map(z => (
                                    <div key={z.id} 
                                        className="absolute border-2 border-dashed border-slate-600 bg-slate-800/20 rounded-lg hover:border-blue-500 transition-colors"
                                        style={{ left: z.x, top: z.y, width: z.width, height: z.height }}
                                        onMouseDown={(e) => startDrag(e, 'zone', z.id)}
                                    >
                                        <div className="absolute -top-6 left-0 text-xs font-mono text-slate-400 bg-slate-900 px-2 py-1 rounded border border-slate-700 flex items-center gap-2">
                                            <Layers size={10}/> {z.name} <span className="text-red-400">SL-{z.slTarget}</span>
                                        </div>
                                    </div>
                                ))}

                                {/* Edges SVG */}
                                <svg className="absolute top-0 left-0 overflow-visible pointer-events-none z-0">
                                    <defs>
                                        <marker id="arrow" markerWidth="10" markerHeight="10" refX="8" refY="3" orient="auto"><path d="M0,0 L0,6 L9,3 z" fill="#64748b" /></marker>
                                    </defs>
                                    {edges.map(e => {
                                        const s = nodes.find(n=>n.id===e.source);
                                        const t = nodes.find(n=>n.id===e.target);
                                        if(!s||!t) return null;
                                        return <path key={e.id} d={getPath(getHandlePos(s,e.handleS), getHandlePos(t,e.handleT))} stroke="#64748b" strokeWidth="2" fill="none" markerEnd="url(#arrow)" />
                                    })}
                                </svg>

                                {/* Nodes */}
                                {nodes.map(n => {
                                    const Type = ASSET_TYPES[n.type];
                                    return (
                                        <div key={n.id}
                                            className="absolute w-[140px] h-[80px] bg-slate-800 border border-slate-600 rounded shadow-xl hover:border-blue-400 group"
                                            style={{ left: n.x, top: n.y }}
                                            onMouseDown={(e) => startDrag(e, 'node', n.id)}
                                        >
                                            <div className="h-1 w-full rounded-t" style={{background:Type.color}}></div>
                                            <div className="p-3 flex items-center gap-3">
                                                <div className="p-2 bg-slate-900 rounded text-slate-300">
                                                    <Box size={16}/>
                                                </div>
                                                <div>
                                                    <div className="text-xs font-bold text-white">{Type.label}</div>
                                                    <div className="text-[10px] text-slate-500">SL-{n.sl}</div>
                                                </div>
                                            </div>
                                            {/* Ports */}
                                            {['t','r','b','l'].map(h => (
                                                <div key={h} className="absolute w-3 h-3 bg-slate-500 rounded-full border border-slate-900 hover:bg-white hover:scale-125 transition-transform"
                                                    style={{
                                                        top: h==='t'?-6:h==='b'?'auto':'50%', 
                                                        bottom: h==='b'?-6:'auto', 
                                                        left: h==='l'?-6:h==='r'?'auto':'50%',
                                                        right: h==='r'?-6:'auto',
                                                        transform: h==='l'||h==='r'?'translateY(-50%)':'translateX(-50%)'
                                                    }}
                                                />
                                            ))}
                                        </div>
                                    )
                                })}
                            </div>

                            {/* 2D Controls Overlay */}
                            <div className="absolute bottom-6 left-6 flex gap-2">
                                <button onClick={()=>setViewport(v=>({...v,zoom:v.zoom+0.1}))} className="p-2 bg-slate-800 rounded border border-slate-700 hover:bg-slate-700"><ZoomIn size={18}/></button>
                                <button onClick={()=>setViewport(v=>({...v,zoom:v.zoom-0.1}))} className="p-2 bg-slate-800 rounded border border-slate-700 hover:bg-slate-700"><ZoomOut size={18}/></button>
                            </div>
                        </div>

                        {/* --- 3D VIEW --- */}
                        <div className={`absolute inset-0 transition-opacity duration-500 ${viewMode==='3D' ? 'opacity-100 z-10' : 'opacity-0 z-0 pointer-events-none'}`}>
                            <Canvas shadows dpr={[1, 2]}>
                                <Scene3D nodes={nodes} zones={zones} edges={edges} />
                            </Canvas>
                            
                            {/* 3D Overlay UI */}
                            <div className="absolute bottom-6 right-6 bg-slate-900/80 backdrop-blur p-4 rounded-xl border border-slate-700 max-w-xs">
                                <h3 className="text-sm font-bold text-white mb-2 flex items-center gap-2"><MousePointer2 size={14}/> CAD Navigation</h3>
                                <div className="text-xs text-slate-400 space-y-1">
                                    <p>• <strong>Left Click + Drag:</strong> Rotate View</p>
                                    <p>• <strong>Right Click + Drag:</strong> Pan View</p>
                                    <p>• <strong>Scroll:</strong> Zoom</p>
                                </div>
                            </div>
                        </div>

                        {/* --- RISK REPORT MODAL --- */}
                        {showReport && (
                            <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-96 bg-slate-900 border border-red-500/50 rounded-xl shadow-2xl p-6 z-50 animate-in fade-in zoom-in">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-xl font-bold text-white flex items-center gap-2">
                                        <AlertTriangle className="text-red-500"/> Threat Report
                                    </h2>
                                    <button onClick={()=>setShowReport(false)} className="text-slate-500 hover:text-white"><LayoutDashboard size={18}/></button>
                                </div>
                                {risks.length === 0 ? (
                                    <div className="text-center py-6 text-slate-400">
                                        <CheckCircle size={48} className="mx-auto mb-3 text-green-500"/>
                                        <p>No critical architecture violations detected.</p>
                                    </div>
                                ) : (
                                    <div className="space-y-3 max-h-60 overflow-y-auto pr-2">
                                        {risks.map((r,i) => (
                                            <div key={i} className="bg-red-950/30 border-l-4 border-red-500 p-3 rounded">
                                                <p className="text-sm text-red-200">{r}</p>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>